# 编译&调试

## GCC编译4个过程

![image-20221130195604365.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221130195604365.png)

1. 预处理：展开宏定义，文件嵌套、删除注释
2. 编译：转换为汇编（检查语法不检查逻辑）
3. 汇编：转换为机器码
4. 链接：符号表查找与填充地址，库的链接，将汇编文件中函数的临时0地址进行填充，将每个符号定义与一个内存位置相关联起来



## 一个程序从开始运行到结束的完整过程（四个过程）

编译预处理、编译、汇编、链接

预处理：（头文件、宏展开、注释去除）gcc -E main.c -o main.i

编译：（语法分析，生成汇编代码）gcc -S main.i -o main.s

汇编：（生成二进制机器码）as main.s -o main.o

链接：（指定路径下寻找库函数）gcc main.o -o main



## 编译优化选项 -o

|      | 编译速度 | 代码大小 | 重点         |      |
| ---- | -------- | -------- | ------------ | ---- |
| o1   | 不变     | 大       |              |      |
| o2   | 牺牲     | 中       |              |      |
| o3   | 牺牲     | 中       | 提高速度     |      |
| os   | 牺牲     | 小       | 降低代码大小 |      |
| og   |          |          | 优化调试体验 |      |



## STM32编译后程序大小与存放位置

1）Code：代码段，存放程序的代码部分；

2）RO-data：(Read Only )只读数据段，存放程序中定义的常量；

3）RW-data：(Read Write)读写数据段，存放初始化为非 0 值的全局变量；

4）ZI-data： (Zero Init) 数据段，存放未初始化的全局变量及初始化为 0 的变量；

```c
Total RO Size (Code + RO Data) 53668 ( 52.41kB)
Total RW Size (RW Data + ZI Data) 2728 ( 2.66kB)
Total ROM Size (Code + RO Data + RW Data) 53780 ( 52.52kB)
```

1）RO Size 包含了 Code 及 RO-data，表示程序占用 Flash 空间的大小；

2）RW Size 包含了 RW-data 及 ZI-data，表示运行时占用的 RAM 的大小；

3）ROM Size 包含了 Code、RO-data 以及 RW-data，表示烧写程序所占用的 Flash 空间的大小；

程序运行之前，需要有文件实体被烧录到 STM32 的 Flash 中，一般是 bin 或者 hex 文件，该被烧录文件称为可执行映像文件。如下图左边部分所示，是可执行映像文件烧录到 STM32 后的内存分布，它包含 RO 段和 RW 段两个部分：其中 RO 段中保存了 Code、RO-data 的数据，RW 段保存了 RW-data 的数据，由于 ZI-data 都是 0，所以未包含在映像文件中。

STM32 在上电启动之后默认从 Flash 启动，启动之后会将 RW 段中的 RW-data（初始化的全局变量）搬运到 RAM 中，但不会搬运 RO 段，即 CPU 的执行代码从 Flash 中读取，另外根据编译器给出的 ZI 地址和大小分配出 ZI 段，并将这块 RAM 区域清零。

![03Memory_distribution.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/03Memory_distribution.png)



编译过程：.c中的变量不分配地址（.o中函数、变量地址为0），链接时依据link file规则分配

链接：将各个.o中的相同段进行合并（.text、.data、.bss），并找到所有符号的引用与定义的位置





## 交叉编译

定义：在一种环境下，编译另一种环境下运行的代码



## 是否遇到了系统稳定性问题

用了指针与结构体，为了实现类似C++的特性，存在野指针问题，定位方式：ozone工具debug

依据寄存器PC指针定位到出问题的代码位置，反推函数调用栈，手动查找，并未使用自动化工具分析


