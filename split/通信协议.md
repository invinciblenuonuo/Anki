# 通信协议 

## 对比

| 协议 | 通信速率                             | 优劣                                                         | 工作模式                                     | 模块数量                                           | 接口数量            | 时序图                                                       |
| ---- | ------------------------------------ | :----------------------------------------------------------- | -------------------------------------------- | -------------------------------------------------- | ------------------- | ------------------------------------------------------------ |
| UART | 115200 bit/s 约100 Kbit/s            | 优势：双线制，全双工  劣势：时序要求严格，速率低             | 全双工，异步（依据约定波特率采样）           | 一对一                                             | TX、RX              | 起始位低电平，数据位8 bit（每Byte数据先发送低位），停止位以及空闲高电平，一帧10 bit<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221109181436534.png" alt="image-20221109181436534" style="zoom: 33%;" /><img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/v2-39dd6c1224d0e3fa0144e90519f4745d_720w.webp" alt="img" style="zoom:80%;" /> |
| 232  |                                      | 优势：规定了电气特性  劣势：传输距离15m，速率低              | 同UART                                       | 一对一                                             |                     |                                                              |
| 485  |                                      | 优势：规定了电气特性，可组网，传输距离远1500m  劣势：半双工  | 半双工                                       | 一对多                                             | A、B                | ![image-20221211170116471.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221211170116471.png) |
| IIC  | 100或400 Kbit/s                      | 优势：双线制，低成本，有应答。  劣势：通信速率低，半双工，通信距离短 | 半双工，同步（起始信号，应答信号，结束信号） | 多主多从（谁控制时钟线谁为主设备）（器件地址唯一） | SDA、SCLK           | 每Byte数据先发送高位，一帧9bit，SCLK（高电平读取，低电平发送）![20180514184751564.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/20180514184751564.png)<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221211112648861.png" alt="image-20221211112648861" style="zoom: 67%;" /> |
| SPI  | 10到150 Mbit/s                       | 优势：全双工高速，数据长度不限。   劣势：从机无应答信号，引脚较多，通信距离短 | 全双工，同步（拉低片选，依据时钟沿采样）     | 一主多从（一、多根互斥的CS片选）（二、菊花链）     | SCK、MOSI、MISO、CS | 每Byte数据先发送高位，帧长不限![watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FzNDgwMTMzOTM3,size_16,color_FFFFFF,t_70.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FzNDgwMTMzOTM3,size_16,color_FFFFFF,t_70.png)![v2-069df3709fb1a0c5486acbf620890313_720w.webp](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/v2-069df3709fb1a0c5486acbf620890313_720w.webp) |
| CAN  | bx CAN：1Mbit/s      CAN FD：8Mbit/s | 优势：差分电平通信距离长。  劣势：速率低带宽小               | 半双工                                       | 不分主从                                           | CANH、CANL          | ![watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc0NjMyNQ==,size_16,color_FFFFFF,t_70#pic_center.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/watermark.png)![image-20221211172121365.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221211172121365.png) |



## UART

空闲时间总线高电平，起始位1bit拉低，数据位8bit，停止位1bit拉高

流控

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608133657320.png" alt="image-20230608133657320" style="zoom: 50%;" />

作用：当通信双方处理速度不一致时

接收方：通过RTS告知对方自己正在处理，占用时拉高（发送方等待），空闲时拉低（发送方发送）

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608134131700.png" alt="image-20230608134131700" style="zoom:67%;" />

发送方：判断CTS信号，拉低时发送

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608134204871.png" alt="image-20230608134204871" style="zoom:67%;" />



## TTL

供电范围在0~5V；>2.7V是高电平；<0.5V是低电平



## RS232

±15V

负电平表示逻辑"1"，正电平表示逻辑"0"，通过提高电压差的方式抗干扰

- 负电平范围为-3V至-15V
- 正电平范围为+3V至+15V

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230725215502450.png" alt="image-20230725215502450" style="zoom:50%;" />



## RS485

±6V

通过差分信号抗干扰，当A线高于B线时，表示逻辑"1"；当B线高于A线时，表示逻辑"0"。

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230725215739796.png" alt="image-20230725215739796" style="zoom:50%;" />



## IIC

- 总线空闲时，SCLK与SDA均为高电平
- 连接到总线上的任一器件，输出低电平，都将使总线的信号变低。
- 连接总线的器件输出级必须是集电极或漏极开路，以形成线“与”功能。
- 每个具有IIC接口的设备都有一个唯一的地址，也叫做设备地址，通讯时需要进行寻址。

![image-20230608100609847.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608100609847.png)

开始信号：SCL 为高电平时，SDA 由高电平向低电平跳变，开始传送数据。（SDA先拉低）
结束信号：SCL 为高电平时，SDA 由低电平向高电平跳变，结束传送数据。（SCL先拉高）
应答信号：每当主机发送完1Byte，总要等待从机给出1bit的应答信号，以确认从机是否成功接收到了数据（主机SCL拉高，读取从机SDA的低电平为应答）

采样点：**稳态电平采样**

**当SCL=1高电平时进行数据采样，数据线SDA不允许有电平跳变，否则视为开始与停止信号**

![image-20221211134858814.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221211134858814.png)

通信过程：

![image-20221211134845009.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221211134845009.png)

1. 主机发送起始信号
2. 主机发送1Byte（从机地址+后续数据传送方向）每个器件具有唯一地址7bit，数据方向：0写1读
3. 从机发送应答信号1bit
4. 发送方与接收方相继发送1Byte+应答信号
5. 主机发送结束信号

写时序

![image-20230608104611870.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608104611870.png)

读时序

![image-20230608104640190.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608104640190.png)

冲突检测与仲裁：（发送方监测，发送电平与SDA电平不符时关闭输出）

- 一种简单的预防冲突机制是：设备在发送数据之前，需要进行冲突检测，检测的依据就是检查SDA的电平状态：只要检测到SDA为低电平，那就是表示总线处于被占用的状态，那么，为了避免发生冲突，当前设备必须等待一段时间以后再次去检测SDA的电平状态，如果总线变成“空闲”的了（即SDA为高电平），那么该设备才能进行通信。

- 这里有一个关键点就是：如何保证连接到I2C总线上的多个的设备，只要存在一个设备占用了总线，其他设备无论如何也不能使总线变为空闲呢？上文说的集电极开路结构就能达到这个要求。
- 每个设备的SDA输出的值，不完全相同，但是，只要有一个为“0”，其结果就是“0”，这就是**线与**，其可以保证SDA线上的信号，要么稳定为“0”（至少一个设备输出为0），要么稳定为“1”（全部设备输出都为1）。

主机代码

```c
//总线启动条件
void IIC_Start(void) {
    SDA = 1;
    SCL = 1;
    IIC_Delay(DELAY_TIME);
    SDA = 0;
    IIC_Delay(DELAY_TIME);
    SCL = 0;	
}

//总线停止条件
void IIC_Stop(void) {
    SDA = 0;
    SCL = 1;
    IIC_Delay(DELAY_TIME);
    SDA = 1;
    IIC_Delay(DELAY_TIME);
}

//通过I2C总线发送数据
void IIC_SendByte(unsigned char byt) {
    unsigned char i;

    for(i=0; i<8; i++)
    {
        SCL  = 0;
        IIC_Delay(DELAY_TIME);
        if(byt & 0x80) 
        	SDA  = 1;
        else 
        	SDA  = 0;
        IIC_Delay(DELAY_TIME);
        SCL = 1;
        byt <<= 1;				//从最高位开始传输数据
        IIC_Delay(DELAY_TIME);
    }
    SCL  = 0;  
}

//等待应答
bit IIC_WaitAck(void) {
    bit ackbit;
	
	SDA  = 1;				//新加，释放数据总线，若被从机拉低证明ACK数据有效
	IIC_Delay(DELAY_TIME);
    SCL  = 1;
    IIC_Delay(DELAY_TIME);
    ackbit = SDA;
	if(ackbit)				//新加，若无应答，则停止总线
		IIC_Stop();
    SCL = 0;
    IIC_Delay(DELAY_TIME);
	
    return ackbit;
}
```

从机代码

```c
//从机发送应答
void IIC_SendAck(bit ackbit) {
    SCL = 0;
    SDA = ackbit;  					// 0：应答，1：非应答
    IIC_Delay(DELAY_TIME);
    SCL = 1;
    IIC_Delay(DELAY_TIME);
    SCL = 0; 
    SDA = 1;
    IIC_Delay(DELAY_TIME);
}

//从I2C总线上接收数据
unsigned char IIC_RecByte(void) {
    unsigned char i, da;
    for(i=0; i<8; i++)
    {   
    	SCL = 1;
		IIC_Delay(DELAY_TIME);
		da <<= 1;					//从高位开始接受数据
		if(SDA) 
			da |= 1;
		SCL = 0;
		IIC_Delay(DELAY_TIME);
    }
    return da;    
}

```



## IIC从机地址配置方式

1. 内部固定地址：某些 I2C 从机设备具有内部固定的从机地址，无法进行配置或更改。在这种情况下，从机地址是设备制造商预定义的。

2. 硬件引脚配置：一些 I2C 从机设备具有专用引脚或引脚配置选项，用于设置从机地址。通过使用跳线帽、电阻、芯片的引脚配置等方式，用户可以将特定的引脚配置为高电平或低电平，从而设置从机地址。

3. 寄存器配置：一些 I2C 从机设备允许使用特殊的寄存器配置来设置从机地址。这通常通过主机和从机之间的特殊序列和命令来实现。



## IIC地址交换

运行过程中，如果新的IIC设备接入，主机和从机如何交换地址？

1. 主机发送广播地址（遍历所有预定义的地址进行扫描），等待应答
2. 从机监听到自己地址后进行应答



## IIC最大设备数量

I2C 协议使用地址来选择特定的从设备进行通信。每个从设备都有一个唯一的 7 位或 10 位地址。

在 I2C 协议中，最多可以有 128 个 7 位地址设备和 1024 个 10 位地址设备。但实际可连接的设备数量受制于总线负载和电气特性等因素。



## SPI

四种模式：

时钟极性(CPOL)定义了时钟空闲状态电平：

- CPOL=0，表示当SCLK=0时处于空闲态，所以有效状态就是SCLK处于高电平时
- CPOL=1，表示当SCLK=1时处于空闲态，所以有效状态就是SCLK处于低电平时

时钟相位(CPHA)定义数据的采集时间。

- CPHA=0，在时钟的第一个跳变沿（上升沿或下降沿）进行数据采样。，在第2个边沿发送数据
- CPHA=1，在时钟的第二个跳变沿（上升沿或下降沿）进行数据采样。，在第1个边沿发送数据

|  mode  | CPOL | CPHA | 描述                                                         |
| :----: | :--: | :--: | ------------------------------------------------------------ |
| mode 0 |  0   |  0   | <img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/988790-20200311120321586-1644899478.png" alt="img" style="zoom:67%;" /> |
| mode 1 |  0   |  1   | <img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/988790-20200311120250511-621966252.png" alt="img" style="zoom:67%;" /> |
| mode 2 |  1   |  0   | <img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/988790-20200311121435779-1051725621.png" alt="img" style="zoom: 80%;" /> |
| mode 3 |  1   |  1   | <img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/988790-20200311121424628-840109130.png" alt="img" style="zoom: 80%;" /> |

一主多从时的连接：（多CS）（菊花链）

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/v2-90fa89c6af8665282dd058768841801f_720w.webp" alt="img" style="zoom: 67%;" /><img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/v2-b15a465be84b4cdde9272cf3ce7eeee6_720w.webp" alt="img" style="zoom:67%;" />

软件SPI与硬件SPI：

- 软件SPI用GPIO口的电平变化模拟SPI通信时序，移植性好，占用CPU资源，速度慢
- 硬件SPI用HAL库封装的**HAL_SPI_Transmit**即可，占用CPU资源少，速度快，但对PCB走线有要求

采样点：**边沿采样**

SPI接口的一个缺点：没有指定的流控制，没有应答机制确认是否接收到数据。

![image-20230715144916989.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230715144916989.png)



## CAN

物理层：两条线差分电平0~5 V，CAN H电压高于CAN L为显性电平（逻辑0），采用CAN收发器将TX RX电平转换为差分，各设备采用ID号区分

![image-20230608160858116.png](https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20230608160858116.png)

标准： bx CAN 2.0 b： 1 Mbps，每帧8 Byte带CRC

​			CAN FD： 8 Mbps，每帧64 Byte

时序：保证总线上各设备时钟不同步情况下，通信是同步的，将1 Bit分为三段再分为多个Tq

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129101750717.png" alt="image-20221129101750717" style="zoom: 33%;" />

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129102857765.png" alt="image-20221129102857765" style="zoom:33%;" />

数据帧：存在连续5个以上相同位，帧中需要插入一个相反的位（stuff bit）

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129144752322.png" alt="image-20221129144752322" style="zoom: 67%;" />

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129102041789.png" alt="image-20221129102041789" style="zoom: 80%;" />

仲裁：CAN 为半双工，不可同时收发，依据ID号中的0的数量进行仲裁

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129102403615.png" alt="image-20221129102403615" style="zoom: 33%;" />

STM32 CAN结构：

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129102808659.png" alt="image-20221129102808659" style="zoom:33%;" />

过滤器：实际使用中采用列表模式，资源紧张时采用掩码模式

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129120519771.png" alt="image-20221129120519771" style="zoom:33%;" />

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129120644982.png" alt="image-20221129120644982" style="zoom:33%;" />

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129120723292.png" alt="image-20221129120723292" style="zoom:33%;" />

​															此处有误，应是`0x00` `0x1FF`与`0x100`掩码，按位与为1的位需要匹配，为0的位不滤除

双接收中断FIFO： 

每当收到一个报文，CAN就将这个报文先与FIFO_0关联的过滤器比较，如果被匹配，就将此报文放入FIFO_0中。如果不匹配，再将报文与FIFO_1关联的过滤器比较，如果被匹配，该报文就放入FIFO_1中。如果还是不匹配，此报文就被丢弃

<img src="https://obsidian-1321127127.cos.ap-beijing.myqcloud.com/image-20221129120918262.png" alt="image-20221129120918262" style="zoom:33%;" />

CAN最多可以挂载110个节点，依据总线负载率<70%